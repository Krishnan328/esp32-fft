<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 FFT Spectrum Analyzer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #222;
            color: #eee;
        }
        h1 {
            color: #4CAF50;
            text-align: center;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        canvas {
            background-color: #000;
            margin-top: 20px;
            width: 100%;
            height: 400px;
            border-radius: 5px;
        }
        .info {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }
        .info div {
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
            flex: 1;
            margin: 0 5px;
            text-align: center;
        }
        .info span {
            font-size: 24px;
            color: #4CAF50;
            display: block;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ESP32 FFT Spectrum Analyzer</h1>
    <canvas id="fftCanvas"></canvas>
    <div class="info">
        <div>
            Dominant Frequency
            <span id="dominantFreq">0 Hz</span>
        </div>
        <div>
            Update Rate
            <span id="updateRate">0 fps</span>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('fftCanvas');
    const ctx = canvas.getContext('2d');
    const dominantFreqElem = document.getElementById('dominantFreq');
    const updateRateElem = document.getElementById('updateRate');

    // Set actual canvas resolution
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;

    // Variables for FPS calculation
    let frameCount = 0;
    let lastFpsUpdateTime = 0;

    // Audio frequency range
    const minFreq = 20;  // 20 Hz
    const maxFreq = 20000;  // 20 kHz

    // Function to draw logarithmic frequency scale
    function drawFrequencyScale() {
        const width = canvas.width;
        const height = canvas.height;

        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, width, height);

        // Draw grid lines
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1;

        // Horizontal grid lines (amplitude)
        for (let i = 0; i < 10; i++) {
            const y = height - (i * height / 10);
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(width, y);
            ctx.stroke();
        }

        // Vertical grid lines (frequency - logarithmic)
        const decades = [20, 50, 100, 200, 500, 1000, 2000, 5000, 10000, 20000];
        ctx.fillStyle = '#888';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';

        decades.forEach(freq => {
            // Convert frequency to x position using logarithmic scale
            const x = width * (Math.log10(freq) - Math.log10(minFreq)) / (Math.log10(maxFreq) - Math.log10(minFreq));

            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
            ctx.stroke();

            // Add frequency label
            let label = freq.toString();
            if (freq >= 1000) {
                label = (freq / 1000) + 'k';
            }
            ctx.fillText(label, x, height - 5);
        });
    }

    // Function to update the spectrum visualization
    function updateSpectrum(magnitudes, dominantFrequency) {
        const width = canvas.width;
        const height = canvas.height;

        // Clear and redraw the background
        drawFrequencyScale();

        // Draw the spectrum
        ctx.beginPath();
        ctx.moveTo(0, height);

        // Go through each FFT bin and map it to the canvas
        for (let i = 1; i < magnitudes.length; i++) {
            // Calculate the frequency for this bin
            const frequency = i * (44100 / 1024);

            // Skip frequencies outside our range
            if (frequency < minFreq || frequency > maxFreq) continue;

            // Convert frequency to x position using logarithmic scale
            const x = width * (Math.log10(frequency) - Math.log10(minFreq)) / (Math.log10(maxFreq) - Math.log10(minFreq));

            // Calculate y position (logarithmic amplitude scaling looks better)
            // Add small value to avoid log(0)
            const magnitude = Math.max(0.0000001, magnitudes[i]);
            const dB = 20 * Math.log10(magnitude);
            const normalizedDb = (dB + 100) / 100;  // Normalize to 0-1 (assuming -100dB to 0dB range)
            const y = height - (normalizedDb * height);

            ctx.lineTo(x, y);
        }

        // Complete the path to the bottom right
        ctx.lineTo(width, height);
        ctx.closePath();

        // Fill the spectrum area with gradient
        const gradient = ctx.createLinearGradient(0, 0, 0, height);
        gradient.addColorStop(0, 'rgba(76, 175, 80, 0.8)');
        gradient.addColorStop(1, 'rgba(76, 175, 80, 0.1)');
        ctx.fillStyle = gradient;
        ctx.fill();

        // Update dominant frequency display
        dominantFreqElem.textContent = dominantFrequency.toFixed(1) + ' Hz';

        // Update FPS counter
        frameCount++;
        const now = performance.now();
        if (now - lastFpsUpdateTime > 1000) {
            const fps = Math.round(frameCount * 1000 / (now - lastFpsUpdateTime));
            updateRateElem.textContent = fps + ' fps';
            frameCount = 0;
            lastFpsUpdateTime = now;
        }
    }

    // Initial draw
    drawFrequencyScale();

    // Function to fetch FFT data
    async function fetchFFTData() {
        try {
            const response = await fetch('/api/fft');
            const data = await response.json();
            updateSpectrum(data.magnitudes, data.dominantFrequency);
        } catch (error) {
            console.error('Error fetching FFT data:', error);
        }

        // Schedule next update
        setTimeout(fetchFFTData, 33); // Aim for ~20 fps
    }

    // Start fetching data
    fetchFFTData();
</script>
</body>
</html>